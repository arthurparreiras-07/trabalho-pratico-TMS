version: '3.8'

services:
# Aplicação Node.js em TypeScript
app:
  build: ./app
  container_name: devops-app
  ports:
    - "3000:3000"
  networks:
    - monitoring
  restart: unless-stopped

# Prometheus - Coleta de métricas
prometheus:
  image: prom/prometheus:latest
  container_name: prometheus
  ports:
    - "9090:9090"
  volumes:
    - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    - ./prometheus/alerts.yml:/etc/prometheus/alerts.yml
    - prometheus-data:/prometheus
  command:
    - '--config.file=/etc/prometheus/prometheus.yml'
    - '--storage.tsdb.path=/prometheus'
    - '--web.enable-lifecycle'
  networks:
    - monitoring
  restart: unless-stopped

# Alertmanager - Gerenciamento de alertas
alertmanager:
  image: prom/alertmanager:latest
  container_name: alertmanager
  ports:
    - "9093:9093"
  volumes:
    - ./alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml
  command:
    - '--config.file=/etc/alertmanager/alertmanager.yml'
  networks:
    - monitoring
  restart: unless-stopped

# Grafana - Visualização de métricas
grafana:
  image: grafana/grafana:latest
  container_name: grafana
  ports:
    - "3001:3000"
  environment:
    - GF_SECURITY_ADMIN_PASSWORD=admin
    - GF_SECURITY_ADMIN_USER=admin
  volumes:
    - grafana-data:/var/lib/grafana
  networks:
    - monitoring
  restart: unless-stopped

networks:
monitoring:
  driver: bridge

volumes:
prometheus-data:
grafana-data: